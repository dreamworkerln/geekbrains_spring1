package jsonrpc.server.entities.product.mappers;

import jsonrpc.protocol.dto.product.ProductItemDto;
import jsonrpc.server.entities.base.mapper.AbstractMapper;
import jsonrpc.server.entities.base.mapper.InstantMapper;
import jsonrpc.server.entities.product.ProductItem;
import jsonrpc.server.service.StorageService;
import jsonrpc.utils.Utils;
import org.mapstruct.*;
import org.springframework.beans.factory.annotation.Autowired;

@Mapper(componentModel = "spring",
        unmappedTargetPolicy = ReportingPolicy.ERROR,
        uses = {InstantMapper.class, ProductMapper.class})
public abstract class ProductItemMapper extends IdMapper {

    @Autowired
    private StorageService storageService;

    //@Mapping(source = "product", target = "productId", qualifiedByName = "toProductDto")
    @Mapping(source = "product.id", target = "productId")
    public abstract ProductItemDto toDto(ProductItem productItem);

    //@Mapping(source = "productId", target = "product", qualifiedByName = "toProduct")
    //@Mapping(source = "productId", target = "id", qualifiedByName = "toEntityId")
    @Mapping(target = "product", ignore = true)
    public abstract ProductItem toEntity(ProductItemDto productItemDto);

//    // ProductItem.product -> ProductItemDto.productId
//    default Long toProductDto(product product) {
//        return product.getId();
//    }
//
//    // ProductItemDto.productId -> ProductItem.product
//    default product toProduct(Long productId) {
//        product result = new product();
//        Utils.idSetter(result, productId);
//        return result;
//    }


    // у product protected setId(), и делать его public я не хочу,
    // а MapStruct не умеет работать через отражения с protected членами
    // (или я не знаю как), поэтому делаем это вручную
    @AfterMapping
    void afterMapping(ProductItemDto source, @MappingTarget ProductItem target) {
        idMap(storageService::findById, source, target);
    }


//    // Map product -> ProductDto (required mapping): product ->  productId
//    @AfterMapping
//    default void setId(ProductItem source, @MappingTarget ProductItemDto target) {
//        target.setProductId(source.getId());
//    }

}
